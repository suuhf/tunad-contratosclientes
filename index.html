<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Tunad - Contratos de Clientes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --lima: #DED138;
            --laranja: #F8773B;
            --azul: #67BBB8;
            --roxo: #A1529A;
            --preto: #191D23;
            --branco: #ffffff;
            --cinza-claro: #f5f5f5;
            --cinza: #e0e0e0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--preto);
            padding: 20px;
        }

        .header {
            position: relative;
            background: var(--preto);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            width: 60px;
            height: 60px;
            position: relative;
        }

        .logo-square {
            width: 18px;
            height: 18px;
            position: absolute;
        }

        .logo-lima { background: var(--lima); top: 0; left: 0; }
        .logo-laranja { background: var(--laranja); top: 0; right: 0; }
        .logo-roxo { background: var(--roxo); bottom: 0; left: 0; }
        .logo-azul { background: var(--azul); bottom: 0; right: 0; }

        .logo-text {
            font-size: 48px;
            font-weight: bold;
            color: var(--branco);
            letter-spacing: 2px;
        }

        .header-info {
            text-align: right;
            color: var(--branco);
        }

        .header-info h2 {
            font-size: 16px;
            font-weight: normal;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .header-info .date {
            font-size: 14px;
            opacity: 0.6;
        }

        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: var(--branco);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid var(--lima);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .kpi-card:nth-child(2) { border-left-color: var(--laranja); }
        .kpi-card:nth-child(3) { border-left-color: var(--azul); }
        .kpi-card:nth-child(4) { border-left-color: var(--roxo); }

        .kpi-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .kpi-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--preto);
            line-height: 1.2;
        }

        .kpi-subtitle {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .filters {
            background: var(--branco);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 600;
            color: var(--preto);
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--cinza);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--azul);
        }

        .table-container {
            background: var(--branco);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, var(--preto) 0%, #2a2e35 100%);
            color: var(--branco);
        }

        thead th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
        }

        thead th:hover {
            background: rgba(255,255,255,0.1);
        }

        tbody tr {
            border-bottom: 1px solid var(--cinza);
            transition: background 0.2s;
            cursor: pointer;
        }

        tbody tr:hover {
            background: var(--cinza-claro);
        }

        tbody td {
            padding: 15px;
            font-size: 14px;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-sim {
            background: rgba(103, 187, 184, 0.2);
            color: var(--azul);
        }

        .badge-risco {
            background: rgba(248, 119, 59, 0.2);
            color: var(--laranja);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .engagement-bar {
            width: 100%;
            height: 8px;
            background: var(--cinza);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }

        .engagement-fill {
            height: 100%;
            transition: width 0.5s ease;
        }

        .engagement-fill.low {
            background: linear-gradient(90deg, var(--laranja), #ff6b6b);
        }

        .engagement-fill.medium {
            background: linear-gradient(90deg, var(--lima), var(--laranja));
        }

        .engagement-fill.high {
            background: linear-gradient(90deg, var(--azul), var(--lima));
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .dashboard-grid.two-cols {
            grid-template-columns: 1fr 1fr;
        }

        .chart-container {
            background: var(--branco);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            margin-bottom: 15px;
            color: var(--preto);
            font-size: 16px;
            border-bottom: 3px solid var(--lima);
            padding-bottom: 8px;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--cinza-claro);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: transform 0.2s;
        }

        .ranking-item:hover {
            transform: translateX(5px);
        }

        .ranking-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--azul);
            color: var(--branco);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .ranking-item.top-1 .ranking-number {
            background: linear-gradient(135deg, var(--lima), #f0e130);
        }

        .ranking-item.top-2 .ranking-number {
            background: linear-gradient(135deg, var(--azul), #5aa9a6);
        }

        .ranking-item.top-3 .ranking-number {
            background: linear-gradient(135deg, var(--laranja), #e66a35);
        }

        .ranking-info {
            flex: 1;
            display: flex;
            align-items: center;
        }

        .ranking-score {
            font-size: 20px;
            font-weight: bold;
            color: var(--preto);
            margin-left: auto;
        }

        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .chart-bar-label {
            width: 150px;
            font-size: 13px;
            font-weight: 600;
        }

        .chart-bar-container {
            flex: 1;
            height: 30px;
            background: var(--cinza);
            border-radius: 15px;
            overflow: hidden;
        }

        .chart-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--azul), var(--roxo));
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: var(--branco);
            font-size: 12px;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--branco);
            margin: 5% auto;
            padding: 0;
            width: 90%;
            max-width: 800px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
            max-height: 85vh;
            overflow-y: auto;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--preto) 0%, #2a2e35 100%);
            color: var(--branco);
            padding: 25px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 24px;
        }

        .modal-header .valor-destaque {
            font-size: 20px;
            color: var(--lima);
            font-weight: bold;
            margin-top: 5px;
        }

        .close {
            color: var(--branco);
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .close:hover {
            transform: scale(1.2);
        }

        .modal-body {
            padding: 30px;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section h3 {
            color: var(--preto);
            margin-bottom: 15px;
            font-size: 18px;
            border-left: 4px solid var(--azul);
            padding-left: 10px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-item {
            background: var(--cinza-claro);
            padding: 15px;
            border-radius: 10px;
        }

        .detail-item label {
            display: block;
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .detail-item value {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: var(--preto);
        }

        .observacoes-box {
            background: #fff9e6;
            border-left: 4px solid var(--lima);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .dashboard-grid.two-cols {
                grid-template-columns: 1fr;
            }
            .detail-grid {
                grid-template-columns: 1fr;
            }
            .kpi-container {
                grid-template-columns: 1fr;
            }
        }

        .dias-restantes {
            font-size: 14px;
            color: #666;
            margin-top: 2px;
        }
        
        .dias-restantes.urgente {
            color: var(--laranja);
            font-weight: bold;
        }
        
        .dias-restantes.atencao {
            color: var(--lima);
        }

        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--cinza-claro);
            border-top: 2px solid var(--cinza);
        }
        
        .pagination-info {
            font-size: 14px;
            color: #666;
        }
        
        .pagination-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .pagination-btn {
            padding: 8px 16px;
            background: var(--azul);
            color: var(--branco);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: var(--roxo);
            transform: translateY(-2px);
        }
        
        .pagination-btn:disabled {
            background: var(--cinza);
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .pagination-pages {
            display: flex;
            gap: 5px;
        }
        
        .pagination-page {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--branco);
            border: 2px solid var(--cinza);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .pagination-page:hover {
            border-color: var(--azul);
            color: var(--azul);
        }
        
        .pagination-page.active {
            background: var(--azul);
            color: var(--branco);
            border-color: var(--azul);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-container">
            <div class="logo">
                <div class="logo-square logo-lima"></div>
                <div class="logo-square logo-laranja"></div>
                <div class="logo-square logo-roxo"></div>
                <div class="logo-square logo-azul"></div>
            </div>
            <div class="logo-text">TUNAD</div>
        </div>
        <div class="header-info">
            <h2>Contratos de Clientes</h2>
            <div class="date" id="currentDate"></div>
        </div>

            

    </div>

    <div class="kpi-container">
        <div class="kpi-card">
            <div class="kpi-label">Receita Mensal Total</div>
            <div class="kpi-value" id="receitaTotal">R$ 0</div>
            <div class="kpi-subtitle">Receita recorrente mensal</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Clientes Ativos</div>
            <div class="kpi-value" id="clientesAtivos">0</div>
            <div class="kpi-subtitle">Contratos em vigor</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Taxa de Engajamento</div>
            <div class="kpi-value" id="taxaEngajamento">0%</div>
            <div class="kpi-subtitle">M√©dia de abertura de reports</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Clientes em Risco</div>
            <div class="kpi-value" id="clientesRisco">0</div>
            <div class="kpi-subtitle">Alto potencial de churn</div>
        </div>

            

    </div>

    <div class="filters">
        <div class="filter-group">
            <label>Pesquisar Cliente</label>
            <input type="text" id="searchInput" placeholder="Digite o nome do cliente...">
        </div>
        <div class="filter-group">
            <label>Filtrar por Ag√™ncia</label>
            <select id="agenciaFilter">
                <option value="">Todas as Ag√™ncias</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Tipo de Contrato</label>
            <select id="contratoFilter">
                <option value="">Todos os Tipos</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Status de Risco</label>
            <select id="riscoFilter">
                <option value="">Todos</option>
                <option value="risco">Em Risco</option>
                <option value="seguro">Seguro</option>
            </select>
        </div>

            

    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th onclick="sortTable(0)" style="cursor:pointer;">Cliente ‚áÖ</th>
                    <th onclick="sortTable(1)" style="cursor:pointer;">Ag√™ncia ‚áÖ</th>
                    <th onclick="sortTable(2)" style="cursor:pointer;">Contrato At√© ‚áÖ</th>
                    <th onclick="sortTable(3)" style="cursor:pointer;">Valor/M√™s ‚áÖ</th>
                    <th onclick="sortTable(4)" style="cursor:pointer;">Tipo ‚áÖ</th>
                    <th onclick="sortTable(5)" style="cursor:pointer;">Engajamento ‚áÖ</th>
                    <th onclick="sortTable(6)" style="cursor:pointer;">Servi√ßos ‚áÖ</th>
                    <th onclick="sortTable(7)" style="cursor:pointer;">Status ‚áÖ</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="8" style="text-align:center;padding:50px;">Carregando dados...</td></tr>
            </tbody>
        </table>
        <div class="pagination-container">
            <div class="pagination-info">
                Mostrando <span id="showingStart">0</span> a <span id="showingEnd">0</span> de <span id="totalClientes">0</span> clientes
            </div>
            <div class="pagination-buttons">
                <button class="pagination-btn" id="btnPrevious" onclick="previousPage()">‚Üê Anterior</button>
                <div class="pagination-pages" id="paginationPages"></div>
                <button class="pagination-btn" id="btnNext" onclick="nextPage()">Pr√≥xima ‚Üí</button>
            </div>
        </div>

            

    </div>

    <div class="dashboard-grid">
        <div class="chart-container">
            <h3>Top 10 - Clientes Mais Engajados</h3>
            <div id="topEngajados"></div>
        </div>
        <div class="chart-container">
            <h3>Top 10 - Clientes Menos Engajados</h3>
            <div id="topMenosEngajados"></div>
        </div>
        <div class="chart-container">
            <h3>Top 10 - Contratos Vencendo</h3>
            <div id="topVencendo"></div>
        </div>

            

    </div>

    <div class="dashboard-grid two-cols">
        <div class="chart-container">
            <h3>Receita por Tipo de Contrato</h3>
            <div id="receitaTipo"></div>
        </div>
        <div class="chart-container">
            <h3>Distribui√ß√£o de Servi√ßos</h3>
            <div id="distribuicaoServicos"></div>
        </div>

            

    </div>

    <div id="clienteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 id="modalTitle">Detalhes do Cliente</h2>
                    <div class="valor-destaque" id="modalValor"></div>
                </div>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>

            

    </div>

    <script>
        // ==================== CONFIGURA√á√ÉO GOOGLE SHEETS ====================
        // COLE SUA URL DO GOOGLE APPS SCRIPT AQUI:
        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbzkMMi2Q-R9ZSpE30ALHjJvrz9HLW5IemlFUE-Kjx2xR2UR3VV6kq4CKq8iZ_1PbGoDzg/exec';
        
        // Atualiza√ß√£o autom√°tica (opcional - em minutos):
        const AUTO_REFRESH_MINUTES = 5; // 0 = desabilitado
        // ===================================================================

        let isLoadingData = false;
        
        // Fun√ß√£o para carregar dados do Google Sheets
        async function loadDataFromGoogleSheets() {
            if (isLoadingData) return;
            
            try {
                isLoadingData = true;
                console.log('üîÑ Carregando dados do Google Sheets...');
                
                const response = await fetch(GOOGLE_SHEETS_URL);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Erro ao carregar dados');
                }

                console.log('‚úÖ Dados recebidos:', result.data.length, 'registros');
                
                // FILTRAR: Remover linhas vazias (sem cliente)
                const dadosFiltrados = result.data.filter(item => {
                    const cliente = item['CLIENTE'];
                    return cliente && cliente !== 'nan' && String(cliente).trim() !== '';
                });
                
                console.log('‚úÖ Clientes v√°lidos:', dadosFiltrados.length);
                
                // Processar e preparar os dados do Sheets
                clientesData = dadosFiltrados.map(cliente => {
                    // Processar valor (formato: "R$ 30.000,00")
                    let valorLimpo = 0;
                    const valorStr = String(cliente['Valor/m√™s'] || '0');
                    
                    if (valorStr && valorStr !== 'Valores n√£o encontrados' && valorStr !== 'Valor n√£o encontrado' && valorStr !== 'nan') {
                        // Remove "R$", espa√ßos, pontos de milhar, e converte v√≠rgula para ponto
                        const valorNumerico = valorStr
                            .replace('R$', '')
                            .replace(/\s/g, '')
                            .replace(/\./g, '')  // Remove pontos de milhar
                            .replace(',', '.');   // Converte v√≠rgula decimal para ponto
                        
                        valorLimpo = parseFloat(valorNumerico) || 0;
                    }
                    cliente.Valor_Limpo = valorLimpo;
                    
                    // Processar abertura de report (dados antigos - mantido para compatibilidade)
                    let abertos = 0;
                    let total = 0;
                    let percentual = 0;
                    
                    const aberturaStr = String(cliente['ABERTURA DE REPORT'] || '0 de 0');
                    const match = aberturaStr.match(/(\d+)\s*de\s*(\d+)/);
                    if (match) {
                        abertos = parseInt(match[1]) || 0;
                        total = parseInt(match[2]) || 0;
                        percentual = total > 0 ? (abertos / total) * 100 : 0;
                    }
                    
                    // NOVAS COLUNAS: Quantidade de pessoas (nomes exatos da planilha)
                    const qtdEnviado = parseInt(cliente['Qtd de pessoas (enviado) - report '] || 0) || 0;  // Note o espa√ßo no final
                    const qtdAcessaram = parseInt(cliente['Qntd de pessoas (acessaram) - reports'] || 0) || 0;  // "Qntd" com n
                    const qtdNaoAcessaram = parseInt(cliente['Diferen√ßa pessoas - reports'] || 0) || 0;  // "Diferen√ßa" mai√∫scula
                    
                    // Calcular taxa de abertura por pessoas (prioridade)
                    let taxaAberturaPessoas = 0;
                    if (qtdEnviado > 0) {
                        taxaAberturaPessoas = (qtdAcessaram / qtdEnviado) * 100;
                    }
                    
                    // Usar taxa de pessoas se dispon√≠vel, sen√£o usar taxa antiga de reports
                    const taxaFinal = qtdEnviado > 0 ? taxaAberturaPessoas : percentual;
                    
                    // NOVAS M√âTRICAS: Acesso √† Ferramenta
                    const usuariosAcessaram = String(cliente['Usu√°rios que acessaram a ferramenta'] || '');
                    const acessoRecente = cliente['Acesso mais recente'] || null;
                    const numUsuarios = parseInt(cliente['N√∫mero de usu√°rios'] || 0) || 0;
                    const qtdUsuariosAcessaram = parseInt(cliente['Qtd de usu√°rios que acessaram'] || 0) || 0;
                    const qtdUsuariosNaoAcessam = parseInt(cliente['Qtd de usu√°rios que n√£o acessam'] || 0) || 0;
                    
                    // Calcular taxa de acesso √† ferramenta
                    let taxaAcessoFerramenta = 0;
                    if (numUsuarios > 0) {
                        taxaAcessoFerramenta = (qtdUsuariosAcessaram / numUsuarios) * 100;
                    }
                    
                    // Gerar insight autom√°tico
                    let insight = '';
                    const diasDesdeAcesso = acessoRecente ? Math.floor((new Date() - new Date(acessoRecente)) / (1000 * 60 * 60 * 24)) : 999;
                    
                    if (taxaFinal < 20 && taxaAcessoFerramenta < 40) {
                        insight = 'üî¥ Baixo engajamento em reports e ferramenta - aten√ß√£o urgente!';
                    } else if (diasDesdeAcesso > 30) {
                        insight = '‚ö†Ô∏è Sem acesso √† ferramenta h√° mais de 30 dias';
                    } else if (qtdNaoAcessaram > qtdAcessaram * 2) {
                        insight = 'üìä Maioria n√£o abre reports - revisar conte√∫do';
                    } else if (taxaAcessoFerramenta > 70 && taxaFinal > 50) {
                        insight = '‚úÖ Excelente engajamento em reports e ferramenta!';
                    } else if (taxaFinal > 50) {
                        insight = 'üìà Bom engajamento com reports';
                    } else if (taxaAcessoFerramenta > 60) {
                        insight = 'üíª Ferramenta bem utilizada';
                    } else {
                        insight = '‚ö° Engajamento moderado - oportunidade de melhoria';
                    }
                    
                    cliente.Abertura_Parsed = {
                        abertos: abertos,
                        total: total,
                        percentual: taxaFinal,
                        qtdEnviado: qtdEnviado,
                        qtdAcessaram: qtdAcessaram,
                        qtdNaoAcessaram: qtdNaoAcessaram
                    };
                    
                    cliente.Ferramenta_Metrics = {
                        usuariosAcessaram: usuariosAcessaram,
                        acessoRecente: acessoRecente,
                        numUsuarios: numUsuarios,
                        qtdUsuariosAcessaram: qtdUsuariosAcessaram,
                        qtdUsuariosNaoAcessam: qtdUsuariosNaoAcessam,
                        taxaAcessoFerramenta: taxaAcessoFerramenta,
                        diasDesdeUltimoAcesso: diasDesdeAcesso
                    };
                    
                    cliente.Insight = insight;
                    
                    return cliente;
                });
                
                console.log('‚úÖ Dados processados:', clientesData.length, 'clientes');
                
                // Reinicializar dashboard
                init();
                
                // Atualizar timestamp
                updateTimestamp();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                alert('Erro ao conectar com Google Sheets: ' + error.message + '\n\nVerifique se:\n1. A URL do Apps Script est√° correta\n2. O script foi implantado corretamente\n3. Voc√™ tem permiss√£o para acessar a planilha');
            } finally {
                isLoadingData = false;
            }
        }
        
        function updateTimestamp() {
            const now = new Date();
            const dateStr = `${String(now.getDate()).padStart(2, '0')}-${String(now.getMonth() + 1).padStart(2, '0')}-${now.getFullYear()}`;
            const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            document.querySelector('.header-info .date').textContent = `Atualizado em ${dateStr} √†s ${timeStr}`;
        }


    let clientesData = [];
    
    let filteredData = [];
    let currentPage = 1;
    const itemsPerPage = 10;

    function init() {
        if (!clientesData || clientesData.length === 0) {
            console.log('‚è≥ Aguardando dados do Google Sheets...');
            return;
        }
        
        console.log('‚úÖ Inicializando dashboard com', clientesData.length, 'clientes');
        
        // Processar dados
        clientesData.forEach(cliente => {
            cliente.valorNumerico = parseFloat(cliente.Valor_Limpo) || 0;
            
            const contratoDate = new Date(cliente['CONTRATO AT√â']);
            const hoje = new Date();
            const diasRestantes = Math.ceil((contratoDate - hoje) / (1000 * 60 * 60 * 24));
            cliente.diasRestantes = diasRestantes;
            cliente.emRisco = (diasRestantes <= 60 && cliente.Abertura_Parsed.percentual < 30);
        });

        filteredData = [...clientesData];
        updateDashboard();
        populateFilters();
        
        const hoje = new Date();
        const dia = String(hoje.getDate()).padStart(2, '0');
        const mes = String(hoje.getMonth() + 1).padStart(2, '0');
        const ano = hoje.getFullYear();
        document.getElementById('currentDate').textContent = `Atualizado em ${dia}-${mes}-${ano}`;
    }

    function updateDashboard() {
        updateKPIs();
        updateTable();
        updateCharts();
    }

    function updateKPIs() {
        const receitaTotal = filteredData.reduce((sum, c) => sum + c.valorNumerico, 0);
        
        // Calcular taxa de engajamento baseada em PESSOAS (n√£o reports)
        const clientesComDados = filteredData.filter(c => 
            c.Abertura_Parsed && 
            c.Abertura_Parsed.qtdEnviado > 0
        );
        
        const taxaEngajamento = clientesComDados.length > 0
            ? clientesComDados.reduce((sum, c) => sum + c.Abertura_Parsed.percentual, 0) / clientesComDados.length
            : 0;
        const clientesRisco = filteredData.filter(c => c.emRisco).length;

        document.getElementById('receitaTotal').textContent = 
            `R$ ${receitaTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        document.getElementById('clientesAtivos').textContent = filteredData.length;
        document.getElementById('taxaEngajamento').textContent = `${taxaEngajamento.toFixed(1)}%`;
        document.getElementById('clientesRisco').textContent = clientesRisco;
    }

    function updateTable() {
        const tbody = document.getElementById('tableBody');
        
        if (filteredData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:50px;">Nenhum cliente encontrado</td></tr>';
            updatePaginationInfo();
            return;
        }

        // Calcular √≠ndices da p√°gina atual
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedData = filteredData.slice(startIndex, endIndex);

        tbody.innerHTML = paginatedData.map((cliente, pageIndex) => {
            const index = startIndex + pageIndex; // √çndice real no filteredData
            const servicos = [];
            if (cliente.Sync === 'Sim') servicos.push('Sync');
            if (cliente['Report Mensal'] === 'Sim') servicos.push('Report Mensal');
            if (cliente['Report Semanal'] === 'Sim') servicos.push('Report Semanal');
            if (cliente['Market Insights'] === 'Sim') servicos.push('Insights');
            if (cliente.API === 'Sim') servicos.push('API');

            const engClass = cliente.Abertura_Parsed.percentual >= 60 ? 'high' : 
                           cliente.Abertura_Parsed.percentual >= 30 ? 'medium' : 'low';

            const contratoDate = new Date(cliente['CONTRATO AT√â']);
            const contratoFormatado = contratoDate.toLocaleDateString('pt-BR', {month: '2-digit', year: 'numeric'});

            const valorExibicao = cliente.valorNumerico > 0 
                ? `R$ ${cliente.valorNumerico.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`
                : 'N/A';

            return `
                <tr onclick="showDetails(${index})">
                    <td><strong>${cliente.CLIENTE}</strong></td>
                    <td>${cliente['AG√äNCIA']}</td>
                    <td>${contratoFormatado}</td>
                    <td><strong>${valorExibicao}</strong></td>
                    <td>${cliente['Tipo de Contrato']}</td>
                    <td>
                        <div>${cliente.Abertura_Parsed.percentual.toFixed(0)}% (${cliente.Abertura_Parsed.abertos}/${cliente.Abertura_Parsed.total})</div>
                        <div class="engagement-bar">
                            <div class="engagement-fill ${engClass}" style="width: ${cliente.Abertura_Parsed.percentual}%"></div>
                        </div>
                    </td>
                    <td><small>${servicos.join(', ') || 'N/A'}</small></td>
                    <td>
                        ${cliente.emRisco ? '<span class="badge badge-risco">‚ö† Risco</span>' : '<span class="badge badge-sim">‚úì OK</span>'}
                    </td>
                </tr>
            `;
        }).join('');
        
        updatePaginationInfo();
    }
    
    function updatePaginationInfo() {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage + 1;
        const endIndex = Math.min(currentPage * itemsPerPage, filteredData.length);
        
        document.getElementById('showingStart').textContent = filteredData.length > 0 ? startIndex : 0;
        document.getElementById('showingEnd').textContent = endIndex;
        document.getElementById('totalClientes').textContent = filteredData.length;
        
        // Atualizar bot√µes
        document.getElementById('btnPrevious').disabled = currentPage === 1;
        document.getElementById('btnNext').disabled = currentPage >= totalPages;
        
        // Atualizar p√°ginas
        const pagesContainer = document.getElementById('paginationPages');
        pagesContainer.innerHTML = '';
        
        // Mostrar no m√°ximo 5 p√°ginas
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('div');
            pageBtn.className = 'pagination-page' + (i === currentPage ? ' active' : '');
            pageBtn.textContent = i;
            pageBtn.onclick = () => goToPage(i);
            pagesContainer.appendChild(pageBtn);
        }
    }
    
    function goToPage(page) {
        currentPage = page;
        updateTable();
    }
    
    function nextPage() {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            updateTable();
        }
    }
    
    function previousPage() {
        if (currentPage > 1) {
            currentPage--;
            updateTable();
        }
    }

    function updateCharts() {
        // Verificar se h√° dados
        if (!clientesData || clientesData.length === 0) {
            // Mensagens de carregamento
            const loadingMsg = '<div style="padding:40px;text-align:center;color:#999;"><div style="font-size:24px;margin-bottom:10px;">üìä</div><div>Carregando dados...</div></div>';
            document.getElementById('topEngajados').innerHTML = loadingMsg;
            document.getElementById('topMenosEngajados').innerHTML = loadingMsg;
            document.getElementById('topVencendo').innerHTML = loadingMsg;
            document.getElementById('receitaTipo').innerHTML = loadingMsg;
            document.getElementById('distribuicaoServicos').innerHTML = loadingMsg;
            return;
        }
        
        // Filtrar clientes com dados de engajamento (qtdEnviado > 0)
        const comReports = clientesData.filter(c => 
            c.Abertura_Parsed && c.Abertura_Parsed.qtdEnviado > 0
        );
        
        // Top Engajados
        const topEngajados = [...comReports].sort((a, b) => b.Abertura_Parsed.percentual - a.Abertura_Parsed.percentual).slice(0, 10);
        
        if (topEngajados.length === 0) {
            document.getElementById('topEngajados').innerHTML = '<div style="padding:40px;text-align:center;color:#999;">Nenhum dado de engajamento dispon√≠vel</div>';
        } else {
            document.getElementById('topEngajados').innerHTML = topEngajados.map((c, i) => {
            const rankClass = i === 0 ? 'top-1' : i === 1 ? 'top-2' : i === 2 ? 'top-3' : '';
            return `
                <div class="ranking-item ${rankClass}">
                    <div class="ranking-number">${i + 1}</div>
                    <div class="ranking-info">
                        <div>
                            <strong>${c.CLIENTE}</strong><br>
                            <small>${c.Abertura_Parsed.qtdNaoAcessaram} n√£o acessaram</small>
                        </div>
                    </div>
                    <div class="ranking-score">${c.Abertura_Parsed.percentual.toFixed(0)}%</div>
                </div>
            `;
        }).join('');

        }
        
        // Top Menos Engajados
        const topMenos = [...comReports].sort((a, b) => a.Abertura_Parsed.percentual - b.Abertura_Parsed.percentual).slice(0, 10);
        
        if (topMenos.length === 0) {
            document.getElementById('topMenosEngajados').innerHTML = '<div style="padding:40px;text-align:center;color:#999;">Nenhum dado de engajamento dispon√≠vel</div>';
        } else {
            document.getElementById('topMenosEngajados').innerHTML = topMenos.map((c, i) => `
            <div class="ranking-item">
                <div class="ranking-number" style="background: var(--laranja)">${i + 1}</div>
                <div class="ranking-info">
                    <div>
                        <strong>${c.CLIENTE}</strong><br>
                        <small>${c.Abertura_Parsed.qtdNaoAcessaram} n√£o acessaram</small>
                    </div>
                </div>
                <div class="ranking-score" style="color: var(--laranja)">${c.Abertura_Parsed.percentual.toFixed(0)}%</div>
            </div>
        `).join('');
        }

        // Receita por Tipo
        const receitaPorTipo = {};
        clientesData.forEach(c => {
            const tipo = c['Tipo de Contrato'] || 'N√£o definido';
            receitaPorTipo[tipo] = (receitaPorTipo[tipo] || 0) + c.valorNumerico;
        });

        const maxReceita = Math.max(...Object.values(receitaPorTipo));
        document.getElementById('receitaTipo').innerHTML = Object.entries(receitaPorTipo)
            .sort((a, b) => b[1] - a[1])
            .map(([tipo, valor]) => `
                <div class="chart-bar">
                    <div class="chart-bar-label">${tipo}</div>
                    <div class="chart-bar-container">
                        <div class="chart-bar-fill" style="width: ${(valor/maxReceita)*100}%">
                            R$ ${valor.toLocaleString('pt-BR', {minimumFractionDigits: 0})}
                        </div>
                    </div>
                </div>
            `).join('');

        // Distribui√ß√£o de Servi√ßos
        const servicos = {
            'Sync': clientesData.filter(c => c.Sync === 'Sim').length,
            'Report Mensal': clientesData.filter(c => c['Report Mensal'] === 'Sim').length,
            'Report Semanal': clientesData.filter(c => c['Report Semanal'] === 'Sim').length,
            'Market Insights': clientesData.filter(c => c['Market Insights'] === 'Sim').length,
            'API': clientesData.filter(c => c.API === 'Sim').length
        };

        const maxServico = Math.max(...Object.values(servicos));
        document.getElementById('distribuicaoServicos').innerHTML = Object.entries(servicos)
            .sort((a, b) => b[1] - a[1])
            .map(([servico, count]) => `
                <div class="chart-bar">
                    <div class="chart-bar-label">${servico}</div>
                    <div class="chart-bar-container">
                        <div class="chart-bar-fill" style="width: ${(count/maxServico)*100}%; background: linear-gradient(90deg, var(--lima), var(--laranja))">
                            ${count} clientes
                        </div>
                    </div>
                </div>
            `).join('');
        
        // Top Contratos Vencendo
        const topVencendo = [...clientesData]
            .sort((a, b) => a.diasRestantes - b.diasRestantes)
            .slice(0, 10);
        
        document.getElementById('topVencendo').innerHTML = topVencendo.map((c, i) => {
            const rankClass = i === 0 ? 'top-1' : i === 1 ? 'top-2' : i === 2 ? 'top-3' : '';
            const diasClass = c.diasRestantes <= 30 ? 'urgente' : c.diasRestantes <= 60 ? 'atencao' : '';
            const contratoDate = new Date(c['CONTRATO AT√â']);
            const contratoFormatado = contratoDate.toLocaleDateString('pt-BR', {month: '2-digit', year: 'numeric'});
            
            return `
                <div class="ranking-item ${rankClass}">
                    <div class="ranking-number">${i + 1}</div>
                    <div class="ranking-info">
                        <div>
                            <strong>${c.CLIENTE}</strong><br>
                            <small>${contratoFormatado}</small>
                            <div class="dias-restantes ${diasClass}">
                                ${c.diasRestantes > 0 ? c.diasRestantes + ' dias' : 'VENCIDO'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        updatePaginationInfo();
    }
    
    function updatePaginationInfo() {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage + 1;
        const endIndex = Math.min(currentPage * itemsPerPage, filteredData.length);
        
        document.getElementById('showingStart').textContent = filteredData.length > 0 ? startIndex : 0;
        document.getElementById('showingEnd').textContent = endIndex;
        document.getElementById('totalClientes').textContent = filteredData.length;
        
        // Atualizar bot√µes
        document.getElementById('btnPrevious').disabled = currentPage === 1;
        document.getElementById('btnNext').disabled = currentPage >= totalPages;
        
        // Atualizar p√°ginas
        const pagesContainer = document.getElementById('paginationPages');
        pagesContainer.innerHTML = '';
        
        // Mostrar no m√°ximo 5 p√°ginas
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('div');
            pageBtn.className = 'pagination-page' + (i === currentPage ? ' active' : '');
            pageBtn.textContent = i;
            pageBtn.onclick = () => goToPage(i);
            pagesContainer.appendChild(pageBtn);
        }
    }
    
    function goToPage(page) {
        currentPage = page;
        updateTable();
    }
    
    function nextPage() {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            updateTable();
        }
    }
    
    function previousPage() {
        if (currentPage > 1) {
            currentPage--;
            updateTable();
        }
    }

    function populateFilters() {
        const agencias = [...new Set(clientesData.map(c => c['AG√äNCIA']))].sort();
        document.getElementById('agenciaFilter').innerHTML = '<option value="">Todas as Ag√™ncias</option>' +
            agencias.map(a => `<option value="${a}">${a}</option>`).join('');

        const tipos = [...new Set(clientesData.map(c => c['Tipo de Contrato']))].sort();
        document.getElementById('contratoFilter').innerHTML = '<option value="">Todos os Tipos</option>' +
            tipos.map(t => `<option value="${t}">${t}</option>`).join('');
    }

    function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const agenciaFilter = document.getElementById('agenciaFilter').value;
        const contratoFilter = document.getElementById('contratoFilter').value;
        const riscoFilter = document.getElementById('riscoFilter').value;

        filteredData = clientesData.filter(cliente => {
            const matchSearch = cliente.CLIENTE.toLowerCase().includes(searchTerm);
            const matchAgencia = !agenciaFilter || cliente['AG√äNCIA'] === agenciaFilter;
            const matchContrato = !contratoFilter || cliente['Tipo de Contrato'] === contratoFilter;
            const matchRisco = !riscoFilter || 
                (riscoFilter === 'risco' && cliente.emRisco) ||
                (riscoFilter === 'seguro' && !cliente.emRisco);

            return matchSearch && matchAgencia && matchContrato && matchRisco;
        });

        currentPage = 1; // Resetar para primeira p√°gina
        updateDashboard();
    }

    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('agenciaFilter').addEventListener('change', applyFilters);
    document.getElementById('contratoFilter').addEventListener('change', applyFilters);
    document.getElementById('riscoFilter').addEventListener('change', applyFilters);

    function showDetails(index) {
        const cliente = filteredData[index];
        const modal = document.getElementById('clienteModal');

        document.getElementById('modalTitle').textContent = cliente.CLIENTE;
        
        const valorExibicao = cliente.valorNumerico > 0 
            ? `R$ ${cliente.valorNumerico.toLocaleString('pt-BR', {minimumFractionDigits: 2})}/m√™s`
            : 'Valor n√£o informado';
        document.getElementById('modalValor').textContent = valorExibicao;

        const contratoDate = new Date(cliente['CONTRATO AT√â']);
        const contratoFormatado = contratoDate.toLocaleDateString('pt-BR');

        const quemAbriu = cliente['QUEM ABRIU'] && cliente['QUEM ABRIU'] !== '-' 
            ? String(cliente['QUEM ABRIU']).replace(/\n/g, '').trim()
            : 'Ningu√©m abriu ainda';

        const servicosAtivos = [];
        if (cliente.Sync === 'Sim') servicosAtivos.push('‚úì Sync');
        if (cliente['Report Mensal'] === 'Sim') servicosAtivos.push('‚úì Report Mensal');
        if (cliente['Report Semanal'] === 'Sim') servicosAtivos.push('‚úì Report Semanal');
        if (cliente['Market Insights'] === 'Sim') servicosAtivos.push('‚úì Market Insights');
        if (cliente.API === 'Sim') servicosAtivos.push('‚úì API');

        document.getElementById('modalBody').innerHTML = `
            <div class="detail-section">
                <h3>Informa√ß√µes Gerais</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>Cliente</label>
                        <value>${cliente.CLIENTE}</value>
                    </div>
                    <div class="detail-item">
                        <label>Ag√™ncia</label>
                        <value>${cliente['AG√äNCIA']}</value>
                    </div>
                    <div class="detail-item">
                        <label>Contrato At√©</label>
                        <value>${contratoFormatado} (${cliente.diasRestantes} dias)</value>
                    </div>
                    <div class="detail-item">
                        <label>Valor Mensal</label>
                        <value>${valorExibicao}</value>
                    </div>
                    <div class="detail-item">
                        <label>Tipo de Contrato</label>
                        <value>${cliente['Tipo de Contrato']}</value>
                    </div>
                    <div class="detail-item">
                        <label>Status de Risco</label>
                        <value>${cliente.emRisco ? '‚ö†Ô∏è Em Risco de Churn' : '‚úÖ Seguro'}</value>
                    </div>
                </div>
            </div>

            <!-- Insight do Cliente -->
            <div class="detail-section" style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-left: 4px solid var(--azul); padding: 15px; margin-bottom: 20px; border-radius: 8px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 20px;">üí°</span>
                    <div style="flex: 1;">
                        <strong style="font-size: 12px; color: #666; text-transform: uppercase;">Insight do Cliente</strong>
                        <p style="margin: 5px 0 0 0; font-size: 14px; color: var(--preto); font-weight: 600;">${cliente.Insight}</p>
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <h3>üìä Engajamento com Reports</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>Taxa de Abertura</label>
                        <value>${cliente.Abertura_Parsed.percentual.toFixed(1)}%</value>
                    </div>
                    <div class="detail-item">
                        <label>Pessoas que Acessaram</label>
                        <value>${cliente.Abertura_Parsed.qtdAcessaram} de ${cliente.Abertura_Parsed.qtdEnviado}</value>
                    </div>
                    <div class="detail-item">
                        <label style="color: #f44336;">Pessoas que N√ÉO Acessaram</label>
                        <value style="color: #f44336; font-weight: bold;">${cliente.Abertura_Parsed.qtdNaoAcessaram} pessoas</value>
                    </div>
                </div>
                <div class="detail-item" style="margin-top: 15px;">
                    <label>Quem Abriu os Reports</label>
                    <value>${quemAbriu}</value>
                </div>
            </div>

            <div class="detail-section">
                <h3>üíª Acesso √† Ferramenta</h3>
                <div class="detail-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="detail-item">
                        <label>√öltimo Acesso</label>
                        <value>${cliente.Ferramenta_Metrics.acessoRecente ? 
                            new Date(cliente.Ferramenta_Metrics.acessoRecente).toLocaleDateString('pt-BR') + ' (' + 
                            cliente.Ferramenta_Metrics.diasDesdeUltimoAcesso + ' dias atr√°s)' 
                            : 'Sem registro'}</value>
                    </div>
                    <div class="detail-item">
                        <label>Taxa de Uso</label>
                        <value style="color: ${cliente.Ferramenta_Metrics.taxaAcessoFerramenta > 50 ? '#4caf50' : '#f44336'}; font-weight: bold;">
                            ${cliente.Ferramenta_Metrics.taxaAcessoFerramenta.toFixed(1)}%
                        </value>
                    </div>
                    <div class="detail-item">
                        <label>Usu√°rios Ativos</label>
                        <value>${cliente.Ferramenta_Metrics.qtdUsuariosAcessaram} de ${cliente.Ferramenta_Metrics.numUsuarios} usu√°rios</value>
                    </div>
                    <div class="detail-item">
                        <label style="color: #f44336;">Usu√°rios Inativos</label>
                        <value style="color: #f44336;">${cliente.Ferramenta_Metrics.qtdUsuariosNaoAcessam} usu√°rios</value>
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <h3>üë• Usu√°rios que Acessaram a Ferramenta</h3>
                <div style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    ${cliente.Ferramenta_Metrics.usuariosAcessaram ? 
                        cliente.Ferramenta_Metrics.usuariosAcessaram.split('\n').filter(u => u.trim()).map(usuario => {
                            const match = usuario.match(/(.+?)\s*\((.+?)\)/);
                            if (match) {
                                const email = match[1].trim();
                                const data = match[2].trim();
                                return `<div style="padding: 8px; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between;">
                                    <span style="color: var(--azul); font-weight: 500;">${email}</span>
                                    <span style="color: #666; font-size: 12px;">${data}</span>
                                </div>`;
                            }
                            return `<div style="padding: 8px; border-bottom: 1px solid #dee2e6;">${usuario}</div>`;
                        }).join('')
                        : '<p style="color: #999; font-style: italic;">Nenhum usu√°rio acessou recentemente</p>'
                    }
                </div>
            </div>

            <div class="detail-section">
                <h3>Servi√ßos Contratados</h3>
                <div class="detail-item">
                    <value>${servicosAtivos.join('<br>') || 'Nenhum servi√ßo ativo'}</value>
                </div>
            </div>

            <div class="detail-section">
                <h3>Observa√ß√µes do Atendimento</h3>
                <div class="observacoes-box">
                    ${cliente['OBSERVA√á√ïES'] || 'Sem observa√ß√µes registradas'}
                </div>
            </div>
        `;

        modal.style.display = 'block';
    }

    document.querySelector('.close').onclick = function() {
        document.getElementById('clienteModal').style.display = 'none';
    }

    window.onclick = function(event) {
        const modal = document.getElementById('clienteModal');
        if (event.target == modal) modal.style.display = 'none';
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            document.getElementById('clienteModal').style.display = 'none';
        }
    });

    let sortDirection = {};
    function sortTable(columnIndex) {
        const direction = sortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';
        sortDirection[columnIndex] = direction;

        filteredData.sort((a, b) => {
            let aVal, bVal;
            switch(columnIndex) {
                case 0: // Cliente
                    aVal = a.CLIENTE || '';
                    bVal = b.CLIENTE || '';
                    break;
                case 1: // Ag√™ncia
                    aVal = a.AGENCIA || '';
                    bVal = b.AGENCIA || '';
                    break;
                case 2: // Contrato At√©
                    aVal = new Date(a['CONTRATO AT√â']);
                    bVal = new Date(b['CONTRATO AT√â']);
                    break;
                case 3: // Valor/M√™s
                    aVal = a.valorNumerico || 0;
                    bVal = b.valorNumerico || 0;
                    break;
                case 4: // Tipo de Contrato
                    aVal = a['Tipo de Contrato'] || '';
                    bVal = b['Tipo de Contrato'] || '';
                    break;
                case 5: // Engajamento (Taxa de Abertura)
                    aVal = a.Abertura_Parsed ? a.Abertura_Parsed.percentual : 0;
                    bVal = b.Abertura_Parsed ? b.Abertura_Parsed.percentual : 0;
                    break;
                case 6: // Servi√ßos (quantidade de servi√ßos ativos)
                    const servicosA = [
                        a.Sync === 'Sim' ? 1 : 0,
                        a['Report Mensal'] === 'Sim' ? 1 : 0,
                        a['Report Semanal'] === 'Sim' ? 1 : 0,
                        a['Market Insights'] === 'Sim' ? 1 : 0,
                        a.API === 'Sim' ? 1 : 0
                    ].reduce((sum, val) => sum + val, 0);
                    const servicosB = [
                        b.Sync === 'Sim' ? 1 : 0,
                        b['Report Mensal'] === 'Sim' ? 1 : 0,
                        b['Report Semanal'] === 'Sim' ? 1 : 0,
                        b['Market Insights'] === 'Sim' ? 1 : 0,
                        b.API === 'Sim' ? 1 : 0
                    ].reduce((sum, val) => sum + val, 0);
                    aVal = servicosA;
                    bVal = servicosB;
                    break;
                case 7: // Status (Em Risco vs Seguro)
                    aVal = a.emRisco ? 1 : 0; // Em risco primeiro
                    bVal = b.emRisco ? 1 : 0;
                    break;
                default: 
                    return 0;
            }

            // Compara√ß√£o
            if (aVal < bVal) return direction === 'asc' ? -1 : 1;
            if (aVal > bVal) return direction === 'asc' ? 1 : -1;
            return 0;
        });

        currentPage = 1; // Resetar para primeira p√°gina
        updateTable();
    }

    init();

        // Verificar configura√ß√£o e carregar dados
        if (GOOGLE_SHEETS_URL === 'COLE_SUA_URL_AQUI') {
            document.getElementById('tableBody').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:50px;color:#f44336;"><h3>‚ö†Ô∏è CONFIGURA√á√ÉO NECESS√ÅRIA</h3><p style="margin-top:15px;">Configure a URL do Google Apps Script no c√≥digo HTML.<br>Procure por: <code>const GOOGLE_SHEETS_URL</code></p></td></tr>';
        } else {
            // Sempre carregar do Google Sheets
            loadDataFromGoogleSheets();
        }
        
        // Auto-refresh (se configurado)
        if (AUTO_REFRESH_MINUTES > 0 && GOOGLE_SHEETS_URL !== 'COLE_SUA_URL_AQUI') {
            setInterval(loadDataFromGoogleSheets, AUTO_REFRESH_MINUTES * 60 * 1000);
            console.log(`‚úÖ Auto-refresh configurado para ${AUTO_REFRESH_MINUTES} minutos`);
        }

    </script>
</body>
</html>